// This is your Prisma schema file
generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// --- Modules ---
model Module {
    id          Int          @id @default(autoincrement())
    name        String
    parent_id   Int?
    parent      Module?      @relation("ModuleParent", fields: [parent_id], references: [id])
    children    Module[]     @relation("ModuleParent")
    permissions Permission[]
}

// --- Permissions ---
model Permission {
    id                     Int                     @id @default(autoincrement())
    module_id              Int
    module                 Module                  @relation(fields: [module_id], references: [id], onDelete: Cascade)
    action                 String
    rolePermissions        RolePermission[]
    userPermissions        UserPermission[]

    @@unique([module_id, action])
}

// --- Roles ---
model Role {
    id              Int              @id @default(autoincrement())
    name            String           @unique
    type            RoleType         @default(internal)
    users           User[]
    rolePermissions RolePermission[]
}

enum RoleType {
    internal
    external
}

// --- Users ---
model User {
    id               Int           @id @default(autoincrement())
    username         String        @unique @db.Citext
    firstName        String?
    lastName         String?
    email            String
    phone            String?
    defaultLanguage  String?
    direction        String?
    facebook         String?
    linkedin         String?
    skype            String?
    profileImage     String?
    emailSignature   String?
    password         String
    is_super_user    Boolean       @default(false)
    is_verified      Boolean       @default(false)
    is_suspended     Boolean       @default(false)
    suspendedAt      DateTime? // Date when user was suspended
    twoFactorEnabled Boolean       @default(false)
    twoFactorType    TwoFactorType @default(disabled)
    role_id          Int?
    role             Role?         @relation(fields: [role_id], references: [id])

    // External/Customer User Fields
    company_name    String? // For external users (customers)
    company_address String? // For external users (customers)

    createdAt          DateTime          @default(now())
    updatedAt          DateTime          @default(now()) @updatedAt
    userPermissions    UserPermission[]
    tasksAssigned      Task[]            @relation("TaskAssignee")
    tasksReported      Task[]            @relation("TaskReporter")
    tasksCreated       Task[]            @relation("TaskCreator")
    taskComments       TaskComment[]     @relation("TaskCommentAuthor")
    uploadedFiles      TaskFile[]        @relation("TaskFileUploader")
    pushSubscriptions  PushSubscription[]
}

enum TwoFactorType {
    disabled
    email
    google
}

// --- Linking Tables ---
model RolePermission {
    role_id       Int
    permission_id Int
    role          Role       @relation(fields: [role_id], references: [id], onDelete: Cascade)
    permission    Permission @relation(fields: [permission_id], references: [id], onDelete: Cascade)

    @@id([role_id, permission_id])
}

model UserPermission {
    user_id       Int
    permission_id Int
    user          User       @relation(fields: [user_id], references: [id], onDelete: Cascade)
    permission    Permission @relation(fields: [permission_id], references: [id], onDelete: Cascade)

    @@id([user_id, permission_id])
}

model Task {
    id          Int        @id @default(autoincrement())
    title       String     // task name
    description String?
    assigned_to Int?
    assignee    User?      @relation("TaskAssignee", fields: [assigned_to], references: [id])
    reporter_id Int        // employee
    reporter    User       @relation("TaskReporter", fields: [reporter_id], references: [id])
    created_by  Int
    creator     User       @relation("TaskCreator", fields: [created_by], references: [id])
    start_date  DateTime   @db.Date
    end_date    DateTime   @db.Date
    status      TaskStatus @default(pending)
    hold_reason String?    // Reason for on_hold status
    is_archived Boolean    @default(false)
    created_at  DateTime   @default(now())
    updated_at  DateTime   @default(now()) @updatedAt

    // Relations
    comments    TaskComment[]
    attachments TaskFile[]
    taskAlerts  TaskAlert[]  @relation("TaskToAlerts")
}

enum TaskStatus {
    pending    // Task is pending
    active     // Task is active/in progress
    on_hold    // Task is on hold
    completed  // Task is completed
    cancelled  // Task is cancelled
}

// Push Notifications
model PushSubscription {
    id            Int      @id @default(autoincrement())
    user_id       Int
    user          User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
    endpoint      String   // Push service endpoint
    auth          String   // Authentication key
    p256dh        String   // P256 Diffie-Hellman public key
    created_at    DateTime @default(now())
    updated_at    DateTime @default(now()) @updatedAt

    @@unique([user_id, endpoint])
    @@index([user_id])
}

// Comments & Files
model TaskComment {
    id       Int      @id @default(autoincrement())
    content  String
    task_id  Int
    task     Task     @relation(fields: [task_id], references: [id])
    user_id  Int
    user     User     @relation("TaskCommentAuthor", fields: [user_id], references: [id])
    created_at   DateTime @default(now())
    updated_at   DateTime @default(now()) @updatedAt
}

model TaskFile {
    id            Int      @id @default(autoincrement())
    filename      String
    original_name String
    file_path     String
    file_size     Int
    task_id       Int
    task          Task     @relation(fields: [task_id], references: [id])
    uploaded_by   Int
    uploader      User     @relation("TaskFileUploader", fields: [uploaded_by], references: [id])
    created_at    DateTime @default(now())
}

// Task Alerts
model TaskAlert {
    id          Int      @id @default(autoincrement())
    task_id     Int
    task        Task     @relation("TaskToAlerts", fields: [task_id], references: [id], onDelete: Cascade)
    alert_date  DateTime
    created_at  DateTime @default(now())
    updated_at  DateTime @default(now()) @updatedAt

    @@index([task_id])
}

model GeneralSetting {
    id                    Int             @id @default(1)
    // Company Information
    company_name          String?
    company_logo          String? // URL or path to logo image
    company_icon          String? // URL or path to icon image
    company_address       String?
    company_phone         String?
    company_trn           String? // TRN (Tax Registration Number)
    default_currency      String          @default("USD")
    currency_sign         String          @default("$")
    // File Storage Configuration
    file_storage_type     FileStorageType @default(local)
    api_key               String?
    amazon_s3_access_key  String?
    amazon_s3_secret_key  String?
    amazon_s3_bucket      String?
    amazon_s3_region      String?
    cloudinary_cloud_name String?
    cloudinary_api_key    String?
    cloudinary_api_secret String?
    updated_at            DateTime        @default(now()) @updatedAt
}

enum FileStorageType {
    local
    amazon_s3
    cloudinary
}
